<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>정글 한 줄</title>

  <!-- JS -->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>

  <style>
    a {
      color: black;
      text-decoration: none;
    }

    a:hover {
      color:goldenrod;
      text-decoration:none;
    }

    .topSection {
      display: flex;
      justify-content: space-between;
      height: 10rem;
      padding-top: 1rem;
    }

    #user_Container {
      text-align: right;

      width: 30rem;
      margin: 1rem 3rem 0 0;
    }
    .middleSection {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;

      margin-top: 5rem;
    }

    #info_Container {
      display: flex;
      flex-direction: row;
      justify-content: space-evenly;
      align-items: center;

      width: 60%;
      height: 25rem;
      margin: 2rem 2rem;

      border: 1px solid black;
    }

    .ImgBox {
      width: 10rem;
      height: 10rem;
    }

    .introduceBox {
      flex-direction: column;
      text-align: center;

      width: 30rem;

      border: 1px solid red;
    }

    .button {
      font-size: larger;
      width: 15rem;
      height: 3rem;
      margin: 0 3rem;

      color: white;
      background-color: darkgreen;
      border-radius: 30px;  
    }

    #keyword_Container {
      width: 75%;
      height: auto;
      margin: 2rem 2rem;

      border: 1px solid black;
    }

    .keywordBox {
      display: flex;
      flex-direction: row;
      align-items: center;

      margin: 0 0 3rem 0;
    }

    .G_keyword {
      font-size: larger;

      display: flex;
      align-items: center;
      justify-content: center;

      width: 10rem;
      height: 3rem;

      margin-left: 1rem;

      color: white;
      background-color: firebrick;
      border-radius: 15px;
    }

    .B_keyword {
      font-size: larger;

      display: flex;
      align-items: center;
      justify-content: center;

      width: 10rem;
      height: 3rem;

      margin-left: 1rem;

      color: white;
      background-color: steelblue;
      border-radius: 15px;
    }

    #comment_Container {
      width: 75%;
      height: 25rem;

      margin: 2rem 2rem;

      border: 1px solid black;
    }

    .commentBox {
      display: flex;
      flex-direction: row;
      align-items: center;

      height: 3rem;

      margin: 2rem;

      border: 1px solid green;
    }

    .nickname {
      font-size: larger;
      margin-left: 3rem;
    }

    .comment {
      font-size: large;
      margin-left: 5rem;
    }
  </style>
</head>
<script>
    $(document).ready( function() {
    showUser()
    });
      
    
    function showUser() {
      if (sessionStorage.getItem('name')) {
        $('#user_Container').append(`
        <div style="font-size:x-large;">
          <a href="/user/${sessionStorage.getItem('name')}/comment" style=" font-size:xx-large;">${sessionStorage.getItem('name')}
          </a>님 반갑습니다
          <span id="logoutButton" style="margin-left:2rem; text-decoration: none; cursor: pointer; font-size:larger;">
            로그아웃
          </span>
        <div>`
        )

        $('#logoutButton').on('click', function () {
        // 로그아웃 시 필요한 동작 수행
        sessionStorage.clear();
        window.location.href = '/';
      });
      
      } else {
        $('#user_Container').append(`
        <div>
          <a href="/user/login" style="text-decoration: none; font-size:xx-large;">로그인
          </a>
          <a href="/user/signup" style="margin-left:2rem; text-decoration: none; font-size:xx-large;">회원가입
          </a>
        <div>`
        )
      }
    }

  // 변수 불러오기(사용자 세션 유지용)
  var loadedId = sessionStorage.getItem("myId");
  // @@ 선택한 교육생 세션, 수정 예정
  var loadedPId = sessionStorage.getItem("pickId");

  // [2-1] "페이지 로딩 후 함수가 실행되게 한다." 
  $(document).ready(function () { // 페이지 로딩시 영화 정보를 출력하는 함수들을 실행되게 합니다.
    showInfo()

    // 내림 차순으로 정렬하는 함수
    keywordSorter()

    // 한줄평을 DB로부터 받아오는 함수
    // comments() 
  });

  // API로부터 교육생 정보 받아오기
  function showInfo() {
    // 컨테이너 비우기
    $('Info_Container').empty()

    $.ajax({
      type: "POST",
      url: "/user/feature/getinfo",
      // 명단에서 클릭한 사람으로 바꿔야
      data: { 'pid_give': loadedPId },
      success: function (response) {
        if (response['result'] != 'success') {
          alert("정보를 받아오지 못했습니다.")
          return
        }

        // API로부터 받은 response에서 user_info의 키 값으로 교육생 정보 얻기
        let userInfo = response['user_info']

        let name = userInfo['Name']
        $('#myName').text(name)
        let mySelf = userInfo['Myself']
        $('#mySelf').text(mySelf)

      }
    })
  }
  function keywordSorter() {
    $('Info_Container').empty()

    $.ajax({
      type: "POST",
      url: "/user/feature/getkey",
      // 명단에서 클릭한 사람으로 바꿔야
      data: { 'pid_give': loadedPId },
      success: function (response) {
        if (response['result'] != 'success') {
          alert("정보를 받아오지 못했습니다.")
          return
        }
        let GKey = response['GKey']
        let BKey = response['BKey']
        // let Nick = response['Nickname']
        let Comments = response['Comment']
        let IsShow = response['IsShow']
        let IsWrited = response['IsWrited']

        if (loadedId == loadedPId && IsShow >= 10) {
          $('#Bkey-list').css('display', 'flex');
        } else {
          $('#Bkey-list').css('display', 'none');
        }

        addKeyword(GKey, BKey, Comments, IsWrited)
      }
    })


    function addKeyword(GKey, BKey, Comments, IsWrited) {
      for (let i = 0; i < GKey.length; i++) {
        let GKeyValue = Object.keys(GKey[i]).join(", "); // GPT

        $('#Gkey-list').append(`
            <span class="G_keyword">${GKeyValue}</span>
        `);
      }
      let BKeyValue = Object.keys(BKey[0]).join(", ");

      $('#Bkey-list').append(`
            <span class="B_keyword">${BKeyValue}</span>
        `);

      for (let i = 0; i < Comments.length; i++) {
        let Comment = Object.values(Comments[i]).join(", "); // GPT
        $('#Comment-list').append(`
          <div class="comment">${Comment}</div>
        `);

        if (IsWrited.includes(loadedId)) {
          $('#Bkey-list').css('display', 'flex');
          $('#Gkey-list').css('display', 'flex');
          $('#Comment-list').css('display', 'flex');
        } else {
          $('#Bkey-list').css('display', 'none');
          $('#Gkey-list').css('display', 'none');
          $('#Comment-list').css('display', 'none');

        }
      }
    }
  }
</script>
<html>

<body>
  <section class="topSection">
    <div class="logo">
      <a href="/main/list"><img src="{{ url_for('static', filename='logo.png') }}" width="300" height="120" style="display:flex"></a>
    </div>
    <div id="user_Container">
    </div>
  </section>  
  <section class="middleSection">
    {% for info in student %}
    <div id="info_Container">
        <img class="ImgBox" src="{{ url_for('static', filename='/uploads/' + info['Img']['filename']) }}" />
      <span>
        <div class="introduceBox">
          <h1 id="myName">{{ info['Name'] }}</h1>
          <h3 id="mySelf">{{ info['Myself'] }}</h3>
          <div></div>
        </div>
      </span>
    </div>
    <div id="keyword_Container">
      <h1 style="padding-left: 2rem;">키워드</h1>
      <div class="keywordBox" id="Gkey-list">

      </div>
      <div class="keywordBox" id="Bkey-list">

      </div>
    </div>
    <div id="comment_Container">
      <h1 style="padding-left: 2rem;">한줄평</h1>
      <div class="commentBox" id="Comment-list">

      </div>
    </div>
    {% endfor %}
    <button class="button" type="button" onclick="location.href='/user/writing'">등록하러 가기</button>    
  </section>
</body>

</html>